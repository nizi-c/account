import { Transaction } from '../models/Transaction';
import { TransactionCard } from './TransactionCard';
import promptAction from '@ohos.promptAction';

/**
 * TransactionList Component
 * äº¤æ˜“åˆ—è¡¨ç»„ä»¶
 * æ”¯æŒè™šæ‹Ÿæ»šåŠ¨ã€ä¾§æ»‘åˆ é™¤ã€ç©ºçŠ¶æ€æ˜¾ç¤º
 * éœ€æ±‚ï¼š1.2, 1.3, 3.1, 3.3, 3.5, 5.6, 7.3
 */
@Component
export struct TransactionList {
  @Link transactions: Transaction[];
  @Prop showDate: boolean = false; // Whether to show full date
  @Prop emptyMessage: string = 'æš‚æ— äº¤æ˜“è®°å½•';
  @Prop emptyIcon: string = 'ðŸ“';
  onDelete?: (transaction: Transaction) => void;
  
  @State deleteDialogVisible: boolean = false;
  @State transactionToDelete: Transaction | null = null;

  /**
   * Handle swipe delete action
   * éœ€æ±‚ï¼š1.2 - ä¾§æ»‘åˆ é™¤
   */
  private handleSwipeDelete(transaction: Transaction) {
    this.transactionToDelete = transaction;
    this.deleteDialogVisible = true;
  }

  /**
   * Confirm delete action
   * éœ€æ±‚ï¼š1.3 - ç¡®è®¤åˆ é™¤
   */
  private confirmDelete() {
    if (this.transactionToDelete && this.onDelete) {
      this.onDelete(this.transactionToDelete);
      
      // Show success toast
      promptAction.showToast({
        message: 'åˆ é™¤æˆåŠŸ',
        duration: 2000
      });
    }
    
    this.deleteDialogVisible = false;
    this.transactionToDelete = null;
  }

  /**
   * Cancel delete action
   */
  private cancelDelete() {
    this.deleteDialogVisible = false;
    this.transactionToDelete = null;
  }

  /**
   * Build UI
   */
  build() {
    Column() {
      if (this.transactions.length === 0) {
        // Empty state (éœ€æ±‚ 5.6)
        this.buildEmptyView();
      } else {
        // Transaction list with virtual scrolling
        this.buildTransactionList();
      }
      
      // Delete confirmation dialog
      if (this.deleteDialogVisible) {
        this.buildDeleteDialog();
      }
    }
    .width('100%')
    .height('100%')
  }

  /**
   * Build transaction list with swipe-to-delete
   * æ”¯æŒè™šæ‹Ÿæ»šåŠ¨ (éœ€æ±‚ 3.1, 3.3)
   * æ€§èƒ½ä¼˜åŒ–ï¼šå¢žåŠ ç¼“å­˜æ•°é‡ï¼Œå¯ç”¨æ‡’åŠ è½½
   */
  @Builder
  buildTransactionList() {
    List({ space: 8 }) {
      ForEach(this.transactions, (transaction: Transaction) => {
        ListItem() {
          TransactionCard({ 
            transaction: transaction,
            showDate: this.showDate
          })
        }
        .swipeAction({ end: this.buildSwipeDeleteButton(transaction) })
      }, (transaction: Transaction) => transaction.id.toString())
    }
    .width('100%')
    .height('100%')
    .padding({ left: 16, right: 16, top: 8, bottom: 8 })
    .scrollBar(BarState.Auto)
    .cachedCount(10) // Virtual scrolling optimization - increased cache
    .edgeEffect(EdgeEffect.Spring) // Smooth scrolling effect
  }

  /**
   * Build swipe delete button
   * éœ€æ±‚ï¼š1.2 - ä¾§æ»‘åˆ é™¤åŠŸèƒ½
   */
  @Builder
  buildSwipeDeleteButton(transaction: Transaction) {
    Button({ type: ButtonType.Normal }) {
      Text('åˆ é™¤')
        .fontSize(16)
        .fontColor(Color.White)
    }
    .width(80)
    .height('100%')
    .backgroundColor('#FF4D4F')
    .borderRadius(8)
    .onClick(() => {
      this.handleSwipeDelete(transaction);
    })
  }

  /**
   * Build empty view
   * éœ€æ±‚ï¼š5.6 - ç©ºçŠ¶æ€æ˜¾ç¤º
   */
  @Builder
  buildEmptyView() {
    Column() {
      Text(this.emptyIcon)
        .fontSize(48)
      
      Text(this.emptyMessage)
        .fontSize(14)
        .fontColor('#999999')
        .margin({ top: 12 })
    }
    .width('100%')
    .height('100%')
    .justifyContent(FlexAlign.Center)
  }

  /**
   * Build delete confirmation dialog
   * éœ€æ±‚ï¼š1.3 - åˆ é™¤ç¡®è®¤å¯¹è¯æ¡†
   */
  @Builder
  buildDeleteDialog() {
    Column() {
      // Overlay background
      Column()
        .width('100%')
        .height('100%')
        .backgroundColor('rgba(0, 0, 0, 0.5)')
        .onClick(() => {
          this.cancelDelete();
        })
      
      // Dialog content
      Column() {
        Text('ç¡®è®¤åˆ é™¤')
          .fontSize(18)
          .fontWeight(FontWeight.Bold)
          .fontColor('#333333')
          .margin({ bottom: 16 })
        
        if (this.transactionToDelete) {
          Text(`ç¡®å®šè¦åˆ é™¤è¿™æ¡${this.transactionToDelete.category}è®°å½•å—ï¼Ÿ`)
            .fontSize(14)
            .fontColor('#666666')
            .textAlign(TextAlign.Center)
            .margin({ bottom: 24 })
        }
        
        Row({ space: 12 }) {
          Button('å–æ¶ˆ')
            .fontSize(16)
            .fontColor('#666666')
            .backgroundColor('#F5F5F5')
            .layoutWeight(1)
            .onClick(() => {
              this.cancelDelete();
            })
          
          Button('åˆ é™¤')
            .fontSize(16)
            .fontColor(Color.White)
            .backgroundColor('#FF4D4F')
            .layoutWeight(1)
            .onClick(() => {
              this.confirmDelete();
            })
        }
        .width('100%')
      }
      .width('80%')
      .padding(24)
      .backgroundColor(Color.White)
      .borderRadius(12)
      .position({ x: '10%', y: '40%' })
    }
    .width('100%')
    .height('100%')
    .position({ x: 0, y: 0 })
    .zIndex(1000)
  }
}
