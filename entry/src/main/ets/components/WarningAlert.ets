import { Budget, BudgetStatus } from '../models';
import { FormatUtils } from '../utils/FormatUtils';
import { ThemeColors, ThemeSpacing, ThemeBorderRadius } from '../utils/ThemeConstants';

/**
 * WarningAlert Component
 * é¢„è­¦æç¤ºç»„ä»¶
 * éœ€æ±‚ï¼š12.5, 12.6 - é¢„è­¦æé†’å’Œè¶…æ”¯è­¦å‘Š
 */
@Component
export struct WarningAlert {
  @Prop budget: Budget;
  @Prop onDismiss?: () => void;

  /**
   * Get alert icon
   */
  private getIcon(): string {
    switch (this.budget.status) {
      case BudgetStatus.WARNING:
        return 'âš ï¸';
      case BudgetStatus.EXCEEDED:
        return 'ðŸš¨';
      default:
        return 'â„¹ï¸';
    }
  }

  /**
   * Get alert title
   */
  private getTitle(): string {
    switch (this.budget.status) {
      case BudgetStatus.WARNING:
        return 'é¢„ç®—é¢„è­¦';
      case BudgetStatus.EXCEEDED:
        return 'é¢„ç®—è¶…æ”¯';
      default:
        return 'æç¤º';
    }
  }

  /**
   * Get alert message
   */
  private getMessage(): string {
    const budgetName = this.getBudgetName();
    
    if (this.budget.status === BudgetStatus.WARNING) {
      return `${budgetName}å·²ä½¿ç”¨ ${this.budget.percentage.toFixed(1)}%ï¼ŒæŽ¥è¿‘é¢„ç®—ä¸Šé™`;
    } else if (this.budget.status === BudgetStatus.EXCEEDED) {
      const exceeded = this.budget.spent - this.budget.amount;
      return `${budgetName}å·²è¶…æ”¯ ${FormatUtils.formatCurrency(exceeded)}`;
    }
    return '';
  }

  /**
   * Get budget name for display
   */
  private getBudgetName(): string {
    if (this.budget.category) {
      return `${this.budget.category}åˆ†ç±»é¢„ç®—`;
    }
    
    if (this.budget.period.includes('W')) {
      return 'å‘¨åº¦é¢„ç®—';
    }
    
    return 'æœˆåº¦é¢„ç®—';
  }

  /**
   * Get alert background color
   */
  private getBackgroundColor(): string {
    switch (this.budget.status) {
      case BudgetStatus.WARNING:
        return ThemeColors.WARNING_LIGHTEST;
      case BudgetStatus.EXCEEDED:
        return ThemeColors.ERROR_LIGHTEST;
      default:
        return ThemeColors.INFO_LIGHTEST;
    }
  }

  /**
   * Get alert border color
   */
  private getBorderColor(): string {
    switch (this.budget.status) {
      case BudgetStatus.WARNING:
        return ThemeColors.WARNING;
      case BudgetStatus.EXCEEDED:
        return ThemeColors.ERROR;
      default:
        return ThemeColors.INFO;
    }
  }

  /**
   * Get title color
   */
  private getTitleColor(): string {
    switch (this.budget.status) {
      case BudgetStatus.WARNING:
        return ThemeColors.WARNING;
      case BudgetStatus.EXCEEDED:
        return ThemeColors.ERROR;
      default:
        return ThemeColors.INFO;
    }
  }

  build() {
    Row() {
      // Icon
      Text(this.getIcon())
        .fontSize(24)
        .margin({ right: ThemeSpacing.SM })
      
      // Content
      Column() {
        Text(this.getTitle())
          .fontSize(16)
          .fontWeight(FontWeight.Medium)
          .fontColor(this.getTitleColor())
          .margin({ bottom: 4 })
        
        Text(this.getMessage())
          .fontSize(14)
          .fontColor(ThemeColors.TEXT_SECONDARY)
      }
      .alignItems(HorizontalAlign.Start)
      .layoutWeight(1)
      
      // Dismiss button
      if (this.onDismiss) {
        Button({ type: ButtonType.Circle }) {
          Text('Ã—')
            .fontSize(20)
            .fontColor(ThemeColors.TEXT_TERTIARY)
        }
        .width(32)
        .height(32)
        .backgroundColor(Color.Transparent)
        .onClick(() => {
          if (this.onDismiss) {
            this.onDismiss();
          }
        })
      }
    }
    .width('100%')
    .padding(ThemeSpacing.MD)
    .backgroundColor(this.getBackgroundColor())
    .borderRadius(ThemeBorderRadius.MD)
    .border({
      width: 1,
      color: this.getBorderColor()
    })
  }
}
