import { BaseRepository } from './BaseRepository';
import { Category, TransactionType } from '../models';
import relationalStore from '@ohos.data.relationalStore';

/**
 * Category Repository
 * åˆ†ç±»æ•°æ®è®¿é—®å±‚
 */
export class CategoryRepository extends BaseRepository {
  private readonly TABLE_NAME = 'categories';

  /**
   * Get all categories
   */
  async getAll(): Promise<Category[]> {
    const store = this.getStore();
    const predicates = new relationalStore.RdbPredicates(this.TABLE_NAME);
    
    try {
      const resultSet = await store.query(predicates);
      const categories = this.mapResultSetToCategories(resultSet);
      resultSet.close();
      return categories;
    } catch (error) {
      console.error('Failed to get all categories:', error);
      throw new Error(`Failed to get all categories: ${error}`);
    }
  }

  /**
   * Get categories by type (income/expense)
   */
  async getByType(type: TransactionType): Promise<Category[]> {
    const store = this.getStore();
    const predicates = new relationalStore.RdbPredicates(this.TABLE_NAME);
    predicates.equalTo('type', type);
    
    try {
      const resultSet = await store.query(predicates);
      const categories = this.mapResultSetToCategories(resultSet);
      resultSet.close();
      return categories;
    } catch (error) {
      console.error('Failed to get categories by type:', error);
      throw new Error(`Failed to get categories by type: ${error}`);
    }
  }

  /**
   * Get default predefined categories
   */
  getDefaultCategories(): Category[] {
    return [
      // Income categories
      { id: 'income_salary', name: 'å·¥èµ„', type: TransactionType.INCOME, icon: 'ğŸ’°', color: '#4CAF50' },
      { id: 'income_bonus', name: 'å¥–é‡‘', type: TransactionType.INCOME, icon: 'ğŸ', color: '#8BC34A' },
      { id: 'income_investment', name: 'æŠ•èµ„æ”¶ç›Š', type: TransactionType.INCOME, icon: 'ğŸ“ˆ', color: '#CDDC39' },
      { id: 'income_parttime', name: 'å…¼èŒ', type: TransactionType.INCOME, icon: 'ğŸ’¼', color: '#66BB6A' },
      { id: 'income_other', name: 'å…¶ä»–æ”¶å…¥', type: TransactionType.INCOME, icon: 'ğŸ’µ', color: '#81C784' },
      
      // Expense categories
      { id: 'expense_food', name: 'é¤é¥®', type: TransactionType.EXPENSE, icon: 'ğŸ”', color: '#FF9800' },
      { id: 'expense_transport', name: 'äº¤é€š', type: TransactionType.EXPENSE, icon: 'ğŸš—', color: '#2196F3' },
      { id: 'expense_shopping', name: 'è´­ç‰©', type: TransactionType.EXPENSE, icon: 'ğŸ›ï¸', color: '#E91E63' },
      { id: 'expense_entertainment', name: 'å¨±ä¹', type: TransactionType.EXPENSE, icon: 'ğŸ®', color: '#9C27B0' },
      { id: 'expense_housing', name: 'ä½æˆ¿', type: TransactionType.EXPENSE, icon: 'ğŸ ', color: '#795548' },
      { id: 'expense_healthcare', name: 'åŒ»ç–—', type: TransactionType.EXPENSE, icon: 'ğŸ’Š', color: '#F44336' },
      { id: 'expense_education', name: 'æ•™è‚²', type: TransactionType.EXPENSE, icon: 'ğŸ“š', color: '#3F51B5' },
      { id: 'expense_utilities', name: 'æ°´ç”µè´¹', type: TransactionType.EXPENSE, icon: 'ğŸ’¡', color: '#FFC107' },
      { id: 'expense_other', name: 'å…¶ä»–æ”¯å‡º', type: TransactionType.EXPENSE, icon: 'ğŸ“', color: '#9E9E9E' }
    ];
  }

  /**
   * Map ResultSet to Category array
   */
  private mapResultSetToCategories(resultSet: relationalStore.ResultSet): Category[] {
    const categories: Category[] = [];
    
    if (resultSet.goToFirstRow()) {
      do {
        categories.push(this.mapResultSetToCategory(resultSet));
      } while (resultSet.goToNextRow());
    }
    
    return categories;
  }

  /**
   * Map single row from ResultSet to Category
   */
  private mapResultSetToCategory(resultSet: relationalStore.ResultSet): Category {
    const idIndex = resultSet.getColumnIndex('id');
    const nameIndex = resultSet.getColumnIndex('name');
    const typeIndex = resultSet.getColumnIndex('type');
    const iconIndex = resultSet.getColumnIndex('icon');
    const colorIndex = resultSet.getColumnIndex('color');

    return {
      id: resultSet.getString(idIndex),
      name: resultSet.getString(nameIndex),
      type: resultSet.getString(typeIndex) as TransactionType,
      icon: resultSet.getString(iconIndex),
      color: resultSet.getString(colorIndex)
    };
  }
}
